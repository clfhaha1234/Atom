# ä»£ç è¿è¡Œç¯å¢ƒåˆ†æ

## å½“å‰å®ç°æ–¹å¼

### ç°çŠ¶ï¼šæµè§ˆå™¨å†…é¢„è§ˆï¼ˆæ— æ²™ç›’ï¼‰

**å®ç°æ–¹å¼**ï¼š
- ä½¿ç”¨æµè§ˆå™¨ `iframe` + `Blob URL` é¢„è§ˆä»£ç 
- é€šè¿‡ CDN åŠ è½½ Reactï¼ˆunpkg.comï¼‰
- ä½¿ç”¨ Babel Standalone åœ¨æµè§ˆå™¨ä¸­ç¼–è¯‘ JSX
- **æ²¡æœ‰çœŸæ­£çš„æœåŠ¡å™¨ç¯å¢ƒ**
- **æ²¡æœ‰åç«¯æ”¯æŒ**
- **æ²¡æœ‰æ•°æ®åº“è¿æ¥**

**ä»£ç ä½ç½®**ï¼š
- `frontend/src/components/CodePreview.tsx`

**å·¥ä½œæµç¨‹**ï¼š
```
AI ç”Ÿæˆä»£ç 
  â†“
å‰ç«¯å°†ä»£ç è½¬æ¢ä¸º HTML
  â†“
ä½¿ç”¨ Blob URL åˆ›å»ºä¸´æ—¶ HTML æ–‡ä»¶
  â†“
åœ¨ iframe ä¸­åŠ è½½å¹¶è¿è¡Œ
  â†“
é€šè¿‡ CDN åŠ è½½ React å’Œ Babel
  â†“
åœ¨æµè§ˆå™¨ä¸­ç¼–è¯‘å’Œè¿è¡Œ
```

### å½“å‰å®ç°çš„é™åˆ¶

âŒ **æ— æ³•æ”¯æŒçš„åŠŸèƒ½**ï¼š
1. **åç«¯ API** - æ— æ³•è¿è¡Œ Node.js/Express åç«¯
2. **æ•°æ®åº“** - æ— æ³•è¿æ¥ PostgreSQL/MySQL ç­‰
3. **npm åŒ…** - åªèƒ½ä½¿ç”¨ CDN æä¾›çš„åº“
4. **æ–‡ä»¶ç³»ç»Ÿ** - æ— æ³•è¯»å†™æ–‡ä»¶
5. **ç¯å¢ƒå˜é‡** - æ— æ³•è®¾ç½® process.env
6. **æ„å»ºå·¥å…·** - æ— æ³•ä½¿ç”¨ Vite/Webpack ç­‰
7. **TypeScript** - åªèƒ½é€šè¿‡ Babel ç®€å•è½¬æ¢
8. **å¤šæ–‡ä»¶é¡¹ç›®** - éš¾ä»¥ç®¡ç†å¤æ‚çš„é¡¹ç›®ç»“æ„

âœ… **å¯ä»¥æ”¯æŒçš„åŠŸèƒ½**ï¼š
1. ç®€å•çš„ React ç»„ä»¶
2. åŸºç¡€ CSS æ ·å¼
3. å‰ç«¯äº¤äº’é€»è¾‘
4. é™æ€å†…å®¹å±•ç¤º

## æ˜¯å¦éœ€è¦æ²™ç›’ç¯å¢ƒï¼Ÿ

### ç­”æ¡ˆï¼š**å–å†³äºåº”ç”¨å¤æ‚åº¦**

#### åœºæ™¯ 1: ç®€å•å‰ç«¯åº”ç”¨ï¼ˆå½“å‰æ–¹æ¡ˆè¶³å¤Ÿï¼‰
- âœ… é™æ€é¡µé¢
- âœ… ç®€å• React ç»„ä»¶
- âœ… çº¯å‰ç«¯äº¤äº’
- **å½“å‰å®ç°å¯ä»¥æ»¡è¶³**

#### åœºæ™¯ 2: å…¨æ ˆåº”ç”¨ï¼ˆéœ€è¦æ²™ç›’ï¼‰
- âŒ éœ€è¦åç«¯ API
- âŒ éœ€è¦æ•°æ®åº“
- âŒ éœ€è¦ npm ä¾èµ–
- **å¿…é¡»ä½¿ç”¨æ²™ç›’ç¯å¢ƒ**

## æ²™ç›’ç¯å¢ƒå®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: å®¹å™¨åŒ–æ²™ç›’ï¼ˆæ¨èï¼‰

**æŠ€æœ¯æ ˆ**ï¼š
- Docker å®¹å™¨
- æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨
- æ”¯æŒå‰åç«¯å®Œæ•´ç¯å¢ƒ

**æ¶æ„**ï¼š
```
ç”¨æˆ·è¯·æ±‚
  â†“
åç«¯ API æ¥æ”¶
  â†“
åˆ›å»º/è·å–ç”¨æˆ·æ²™ç›’å®¹å™¨
  â†“
åœ¨å®¹å™¨ä¸­ï¼š
  - å®‰è£…ä¾èµ– (npm install)
  - å¯åŠ¨å‰ç«¯æœåŠ¡ (vite dev)
  - å¯åŠ¨åç«¯æœåŠ¡ (node server.js)
  - è¿æ¥æ•°æ®åº“
  â†“
è¿”å›è¿è¡Œ URL
  â†“
å‰ç«¯ iframe åŠ è½½è¿è¡Œç¯å¢ƒ
```

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// backend/src/services/sandbox.ts
import Docker from 'dockerode'

class SandboxService {
  async createSandbox(userId: string, code: Record<string, string>) {
    // 1. åˆ›å»ºä¸´æ—¶ç›®å½•
    const projectDir = `/tmp/sandbox/${userId}/${Date.now()}`
    await fs.mkdir(projectDir, { recursive: true })
    
    // 2. å†™å…¥ä»£ç æ–‡ä»¶
    for (const [file, content] of Object.entries(code)) {
      await fs.writeFile(`${projectDir}/${file}`, content)
    }
    
    // 3. åˆ›å»º Docker å®¹å™¨
    const container = await docker.createContainer({
      Image: 'node:18',
      Cmd: ['npm', 'start'],
      WorkingDir: '/app',
      HostConfig: {
        Binds: [`${projectDir}:/app`],
        PortBindings: {
          '3000/tcp': [{ HostPort: '0' }] // åŠ¨æ€ç«¯å£
        }
      }
    })
    
    // 4. å¯åŠ¨å®¹å™¨
    await container.start()
    
    // 5. è¿”å›è®¿é—® URL
    const port = await this.getContainerPort(container)
    return `http://localhost:${port}`
  }
}
```

### æ–¹æ¡ˆ 2: äº‘æ²™ç›’æœåŠ¡ï¼ˆæ›´ç®€å•ï¼‰

**ä½¿ç”¨ç°æœ‰æœåŠ¡**ï¼š
- **CodeSandbox API** - æä¾›æ²™ç›’ç¯å¢ƒ
- **StackBlitz** - WebContainer æŠ€æœ¯
- **Replit** - åœ¨çº¿ IDE å’Œè¿è¡Œç¯å¢ƒ

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// ä½¿ç”¨ CodeSandbox API
async function createSandbox(code: Record<string, string>) {
  const response = await fetch('https://codesandbox.io/api/v1/sandboxes', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${CODESANDBOX_API_KEY}`
    },
    body: JSON.stringify({
      files: code,
      template: 'create-react-app'
    })
  })
  
  const { sandbox } = await response.json()
  return `https://${sandbox.id}.csb.app`
}
```

### æ–¹æ¡ˆ 3: è½»é‡çº§ Node.js æ²™ç›’

**ä½¿ç”¨ vm2 æˆ– isolated-vm**ï¼š
- åœ¨ Node.js è¿›ç¨‹ä¸­è¿è¡Œä»£ç 
- æä¾›éš”ç¦»ç¯å¢ƒ
- é€‚åˆç®€å•çš„åç«¯é€»è¾‘

**é™åˆ¶**ï¼š
- æ— æ³•è¿è¡Œå®Œæ•´çš„ Web æœåŠ¡å™¨
- èµ„æºå—é™

## æ¨èæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¤æ‚åº¦ | æˆæœ¬ | éš”ç¦»æ€§ | åŠŸèƒ½å®Œæ•´æ€§ | æ¨èåº¦ |
|------|--------|------|--------|-----------|--------|
| å½“å‰æ–¹æ¡ˆï¼ˆæµè§ˆå™¨é¢„è§ˆï¼‰ | â­ ä½ | å…è´¹ | âŒ æ— éš”ç¦» | â­â­ ä»…å‰ç«¯ | é€‚åˆ MVP |
| Docker å®¹å™¨ | â­â­â­ ä¸­ | ä¸­ç­‰ | âœ… å®Œå…¨éš”ç¦» | â­â­â­â­â­ å®Œæ•´ | â­â­â­â­â­ |
| äº‘æ²™ç›’æœåŠ¡ | â­â­ ä½ | æŒ‰é‡ä»˜è´¹ | âœ… å®Œå…¨éš”ç¦» | â­â­â­â­ è¾ƒå®Œæ•´ | â­â­â­â­ |
| Node.js vm2 | â­â­ ä¸­ | å…è´¹ | â­â­â­ éƒ¨åˆ†éš”ç¦» | â­â­â­ éƒ¨åˆ† | â­â­â­ |

## å®ç°å»ºè®®

### MVP é˜¶æ®µï¼ˆå½“å‰ï¼‰
âœ… **ä¿æŒå½“å‰æ–¹æ¡ˆ**
- é€‚åˆç®€å•çš„å‰ç«¯åº”ç”¨
- é›¶æˆæœ¬
- å¿«é€Ÿå®ç°

### ä¸‹ä¸€é˜¶æ®µ
ğŸš€ **å®ç° Docker æ²™ç›’**
- æ”¯æŒå…¨æ ˆåº”ç”¨
- å®Œæ•´çš„è¿è¡Œç¯å¢ƒ
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### å®ç°æ­¥éª¤

1. **åˆ›å»ºæ²™ç›’æœåŠ¡**
   ```typescript
   // backend/src/services/sandbox.ts
   - createSandbox(userId, code)
   - startSandbox(containerId)
   - stopSandbox(containerId)
   - getSandboxUrl(containerId)
   ```

2. **é›†æˆåˆ°å·¥ä½œæµ**
   ```typescript
   // åœ¨ alexCodeGenNode å
   - ç”Ÿæˆä»£ç 
   - åˆ›å»ºæ²™ç›’ç¯å¢ƒ
   - å®‰è£…ä¾èµ–
   - å¯åŠ¨æœåŠ¡
   - è¿”å›è¿è¡Œ URL
   ```

3. **å‰ç«¯æ›´æ–°**
   ```typescript
   // CodePreview ç»„ä»¶
   - æ£€æµ‹æ˜¯å¦æœ‰æ²™ç›’ URL
   - å¦‚æœæœ‰ï¼ŒåŠ è½½æ²™ç›’ URL
   - å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨å½“å‰é¢„è§ˆæ–¹æ¡ˆ
   ```

## æ€»ç»“

**å½“å‰å®ç°**ï¼š
- âœ… ç®€å•ã€å¿«é€Ÿã€é›¶æˆæœ¬
- âŒ ä»…æ”¯æŒç®€å•å‰ç«¯åº”ç”¨
- âŒ æ— æ³•è¿è¡Œåç«¯å’Œæ•°æ®åº“

**æ˜¯å¦éœ€è¦æ²™ç›’**ï¼š
- ç®€å•åº”ç”¨ï¼šä¸éœ€è¦ï¼ˆå½“å‰æ–¹æ¡ˆè¶³å¤Ÿï¼‰
- å…¨æ ˆåº”ç”¨ï¼šéœ€è¦ï¼ˆDocker å®¹å™¨æ–¹æ¡ˆï¼‰

**å»ºè®®**ï¼š
1. MVP é˜¶æ®µä¿æŒå½“å‰æ–¹æ¡ˆ
2. éœ€è¦æ—¶å®ç° Docker æ²™ç›’
3. æˆ–é›†æˆ CodeSandbox/StackBlitz ç­‰äº‘æœåŠ¡
