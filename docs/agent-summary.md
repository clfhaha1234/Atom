# Agent åä½œæœºåˆ¶æ€»ç»“

## ğŸ“‹ å¿«é€Ÿæ¦‚è§ˆ

### å½“å‰å®ç°çš„å·¥ä½œæµ

```
ç”¨æˆ·æ¶ˆæ¯
  â†“
Mike (Supervisor) æ£€æŸ¥çŠ¶æ€
  â†“
å†³å®šä¸‹ä¸€æ­¥è¯¥è°å·¥ä½œ
  â†“
æ‰§è¡Œå¯¹åº” Agent (Emma/Bob/Alex)
  â†“
æ›´æ–°å…±äº«çŠ¶æ€
  â†“
è¿”å›å“åº”
  â†“
[å¾ªç¯ç›´åˆ°å®Œæˆ]
```

## ğŸ”„ åä½œæœºåˆ¶è¯¦è§£

### 1. **çŠ¶æ€å…±äº« (State Sharing)**

æ‰€æœ‰ Agent é€šè¿‡ `ProjectState` å¯¹è±¡å…±äº«ä¿¡æ¯ï¼š

```typescript
interface ProjectState {
  userMessage: string           // ç”¨æˆ·åŸå§‹éœ€æ±‚
  currentStatus: string        // å½“å‰é˜¶æ®µ
  prd?: string                 // Emma çš„è¾“å‡º
  architecture?: string        // Bob çš„è¾“å‡º  
  code?: Record<string, string> // Alex çš„è¾“å‡º
  nextAgent?: string           // Mike çš„å†³ç­–ç»“æœ
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… æ‰€æœ‰ Agent è¯»å–å’Œå†™å…¥åŒä¸€ä¸ª state å¯¹è±¡
- âœ… æ¯ä¸ª Agent å¯ä»¥çœ‹åˆ°ä¹‹å‰ Agent çš„è¾“å‡º
- âœ… çŠ¶æ€åœ¨å†…å­˜ä¸­ä¼ é€’ï¼Œä¸æŒä¹…åŒ–

### 2. **å†³ç­–æœºåˆ¶ (Decision Making)**

**Mike (Supervisor) çš„å·¥ä½œæµç¨‹**ï¼š

```
1. æ¥æ”¶å½“å‰ state
   â†“
2. æ£€æŸ¥å·²å®Œæˆå·¥ä½œï¼š
   - PRD æ˜¯å¦å­˜åœ¨ï¼Ÿ
   - æ¶æ„è®¾è®¡æ˜¯å¦å­˜åœ¨ï¼Ÿ
   - ä»£ç æ˜¯å¦å­˜åœ¨ï¼Ÿ
   â†“
3. è°ƒç”¨ LLM åˆ¤æ–­ï¼š
   - ç¼ºå°‘ PRD â†’ è¿”å› "emma"
   - ç¼ºå°‘æ¶æ„ â†’ è¿”å› "bob"
   - ç¼ºå°‘ä»£ç  â†’ è¿”å› "alex"
   - å…¨éƒ¨å®Œæˆ â†’ è¿”å› "complete"
   â†“
4. æ›´æ–° state.nextAgent
```

**å†³ç­– Prompt ç¤ºä¾‹**ï¼š
```
ä½ æ˜¯ Atoms å›¢é˜Ÿçš„ Team Leader Mikeã€‚

ç”¨æˆ·éœ€æ±‚: åšä¸€ä¸ªå¾…åŠäº‹é¡¹åº”ç”¨
å½“å‰çŠ¶æ€: planning
å·²å®Œæˆå·¥ä½œ: 
- PRD: âŒ
- æ¶æ„è®¾è®¡: âŒ
- ä»£ç ç”Ÿæˆ: âŒ

è¯·å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨:
1. å¦‚æœéœ€è¦ PRD,è¿”å› "emma"
2. å¦‚æœéœ€è¦æ¶æ„è®¾è®¡,è¿”å› "bob"
3. å¦‚æœéœ€è¦ç¼–ç ,è¿”å› "alex"
4. å¦‚æœå·²å®Œæˆ,è¿”å› "complete"
```

### 3. **ä¿¡æ¯æ²Ÿé€š (Communication)**

**Agent ä¹‹é—´çš„ä¿¡æ¯ä¼ é€’**ï¼š

| ä» | åˆ° | ä¼ é€’æ–¹å¼ | ä¼ é€’å†…å®¹ |
|---|---|---------|---------|
| ç”¨æˆ· | æ‰€æœ‰ Agent | `state.userMessage` | ç”¨æˆ·åŸå§‹éœ€æ±‚ |
| Emma | Bob | `state.prd` | PRD æ–‡æ¡£ |
| Emma | Alex | `state.prd` | PRD æ–‡æ¡£ |
| Bob | Alex | `state.architecture` | æ¶æ„è®¾è®¡ |

**ç¤ºä¾‹**ï¼š
```typescript
// Bob å¯ä»¥çœ‹åˆ° Emma çš„ PRD
const prompt = `ä½œä¸ºæ¶æ„å¸ˆ Bob,ä¸ºä»¥ä¸‹é¡¹ç›®è®¾è®¡æŠ€æœ¯æ¶æ„:
ç”¨æˆ·éœ€æ±‚: ${state.userMessage}
PRD: ${state.prd || 'æš‚æ— '}  // â† Emma çš„è¾“å‡º
`

// Alex å¯ä»¥çœ‹åˆ° PRD å’Œæ¶æ„
const prompt = `ä½œä¸ºå·¥ç¨‹å¸ˆ Alex,ä¸ºä»¥ä¸‹é¡¹ç›®ç”Ÿæˆä»£ç :
ç”¨æˆ·éœ€æ±‚: ${state.userMessage}
PRD: ${state.prd || 'æš‚æ— '}           // â† Emma çš„è¾“å‡º
æ¶æ„: ${state.architecture || 'æš‚æ— '} // â† Bob çš„è¾“å‡º
`
```

### 4. **å®Œæˆåˆ¤æ–­ (Completion Detection)**

**å®Œæˆæ¡ä»¶**ï¼š
```typescript
// æ–¹å¼1: æ£€æŸ¥æ‰€æœ‰å¿…éœ€å­—æ®µ
if (state.prd && state.architecture && state.code) {
  // é¡¹ç›®å®Œæˆ
}

// æ–¹å¼2: æ£€æŸ¥çŠ¶æ€
if (state.currentStatus === 'complete') {
  // é¡¹ç›®å®Œæˆ
}

// æ–¹å¼3: Supervisor è¿”å› "complete"
if (state.nextAgent === 'complete') {
  // é¡¹ç›®å®Œæˆ
}
```

**å®Œæˆæµç¨‹**ï¼š
1. Alex ç”Ÿæˆä»£ç åï¼Œè®¾ç½® `currentStatus = 'complete'`
2. ä¸‹æ¬¡å¾ªç¯æ—¶ï¼ŒSupervisor æ£€æŸ¥åˆ°æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨
3. Supervisor è¿”å› `nextAgent = 'complete'`
4. å¾ªç¯é€€å‡ºï¼Œè¿”å›æœ€ç»ˆå“åº”

## ğŸ“Š æµ‹è¯•ç»“æœ

### âœ… åŸºç¡€æµ‹è¯•é€šè¿‡

**æµ‹è¯•åœºæ™¯**: "åšä¸€ä¸ªå¾…åŠäº‹é¡¹åº”ç”¨"

**æ‰§è¡Œæµç¨‹**:
```
è¿­ä»£ 1: Mike å†³ç­– â†’ Emma ç”Ÿæˆ PRD âœ…
è¿­ä»£ 2: Mike å†³ç­– â†’ Bob è®¾è®¡æ¶æ„ âœ… (å¯ä»¥çœ‹åˆ° Emma çš„ PRD)
è¿­ä»£ 3: Mike å†³ç­– â†’ Alex ç”Ÿæˆä»£ç  âœ… (å¯ä»¥çœ‹åˆ° PRD å’Œæ¶æ„)
```

**ç»“æœ**:
- âœ… æ€»è¿­ä»£æ¬¡æ•°: 3
- âœ… æ‰€æœ‰ Agent æ­£ç¡®æ‰§è¡Œ
- âœ… çŠ¶æ€æ­£ç¡®ä¼ é€’
- âœ… å®Œæˆåˆ¤æ–­å‡†ç¡®

### âœ… éªŒè¯ç‚¹

1. **å†³ç­–æœºåˆ¶** âœ…
   - Supervisor èƒ½æ­£ç¡®åˆ¤æ–­ä¸‹ä¸€æ­¥è¯¥è°å·¥ä½œ
   - å†³ç­–é€»è¾‘ç¬¦åˆé¢„æœŸ

2. **çŠ¶æ€ä¼ é€’** âœ…
   - Bob å¯ä»¥çœ‹åˆ° Emma çš„ PRD
   - Alex å¯ä»¥çœ‹åˆ° PRD å’Œæ¶æ„
   - çŠ¶æ€å¯¹è±¡æ­£ç¡®æ›´æ–°

3. **å®Œæˆåˆ¤æ–­** âœ…
   - æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨æ—¶ï¼Œæ­£ç¡®åˆ¤æ–­ä¸ºå®Œæˆ
   - å¾ªç¯æ­£ç¡®é€€å‡º

## âš ï¸ å½“å‰é™åˆ¶

### 1. å•æ¬¡è¿”å›é™åˆ¶
- **ç°çŠ¶**: æ¯æ¬¡ `invoke()` åªè¿”å›ä¸€ä¸ª Agent çš„å“åº”
- **å½±å“**: å‰ç«¯éœ€è¦å¤šæ¬¡è°ƒç”¨æ‰èƒ½çœ‹åˆ°å®Œæ•´æµç¨‹
- **æ”¹è¿›**: å®ç°æµå¼å“åº”

### 2. çŠ¶æ€ä¸æŒä¹…åŒ–
- **ç°çŠ¶**: State åªåœ¨å†…å­˜ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨é‡æ–°åˆå§‹åŒ–
- **å½±å“**: æ— æ³•æ”¯æŒå¤šè½®å¯¹è¯å’ŒçŠ¶æ€æ¢å¤
- **æ”¹è¿›**: å°† State ä¿å­˜åˆ°æ•°æ®åº“

### 3. ä¸¥æ ¼é¡ºåºæ‰§è¡Œ
- **ç°çŠ¶**: ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼ˆEmma â†’ Bob â†’ Alexï¼‰
- **å½±å“**: æ— æ³•æ”¯æŒéœ€è¦å¹¶è¡Œå·¥ä½œçš„åœºæ™¯
- **æ”¹è¿›**: æ”¯æŒæŸäº› Agent å¹¶è¡Œå·¥ä½œ

## ğŸš€ æ”¹è¿›å»ºè®®

### 1. æµå¼å“åº”
```typescript
async function* invokeStream(state: ProjectState) {
  while (!isComplete(state)) {
    const nextAgent = await supervisorNode(state)
    yield { type: 'agent_start', agent: nextAgent }
    
    const result = await executeAgent(nextAgent, state)
    yield { type: 'agent_complete', agent: nextAgent, result }
    
    updateState(state, result)
  }
}
```

### 2. çŠ¶æ€æŒä¹…åŒ–
```typescript
// ä¿å­˜çŠ¶æ€
await supabase.from('project_states').upsert({
  project_id: projectId,
  state: JSON.stringify(state),
  updated_at: new Date()
})
```

### 3. å¹¶è¡Œæ‰§è¡Œ
```typescript
// æŸäº› Agent å¯ä»¥å¹¶è¡Œ
if (canParallelExecute(state)) {
  const [prd, architecture] = await Promise.all([
    emmaPRDNode(state),
    bobArchitectureNode(state)
  ])
}
```

## ğŸ“ æ€»ç»“

### âœ… æ ¸å¿ƒæœºåˆ¶éªŒè¯é€šè¿‡

1. **Supervisor å†³ç­–é€»è¾‘** âœ…
   - èƒ½å¤Ÿæ ¹æ®å½“å‰çŠ¶æ€æ­£ç¡®åˆ¤æ–­ä¸‹ä¸€æ­¥
   - å†³ç­– Prompt è®¾è®¡åˆç†

2. **Agent åä½œæµç¨‹** âœ…
   - æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œ
   - æ¯ä¸ª Agent éƒ½èƒ½çœ‹åˆ°å¿…è¦ä¿¡æ¯

3. **çŠ¶æ€ä¼ é€’æœºåˆ¶** âœ…
   - é€šè¿‡å…±äº« state å¯¹è±¡ä¼ é€’ä¿¡æ¯
   - çŠ¶æ€æ›´æ–°åŠæ—¶å‡†ç¡®

4. **å®Œæˆåˆ¤æ–­é€»è¾‘** âœ…
   - èƒ½å¤Ÿå‡†ç¡®åˆ¤æ–­é¡¹ç›®æ˜¯å¦å®Œæˆ
   - å¾ªç¯æ­£ç¡®é€€å‡º

### ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯¦ç»†åä½œæœºåˆ¶è¯´æ˜](./agent-collaboration.md)
- [æµ‹è¯•æŠ¥å‘Š](../backend/src/agents/__tests__/test-report.md)
- [æµ‹è¯•ä»£ç ](../backend/src/agents/__tests__/mike.test.ts)
